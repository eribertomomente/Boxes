<html>
	<head>
		<title>Starting Code for 1st Project 2017</title>
		<style>

		body {
			font-family: Monospace;
			background-color: #f0f0f0;
			margin: 0px;
			overflow: hidden;
		}

		canvas {
			width: 100%;
			height: 100%;
		}

	</style>
		<script src="lib/three.min.js"></script>
		<script src="lib/stats.min.js"></script>
		<script src="lib/OrbitControls.js"></script>
		<script src="obj/Arena.js"></script>
		<script src="obj/SnakeGame.js"></script>
		<script src="obj/Snake.js"></script>
		<script src="config.js"></script>
	</head>
	<body>

		<script>

		var scene, camera, renderer, controls, stats;

		//return array with height data from img, taken from: http://danni-three.blogspot.it/2013/09/threejs-heightmaps.html
		function getHeightData(img,scale) {

			if (scale == undefined) scale=1;

		    var canvas = document.createElement( 'canvas' );
		    canvas.width = img.width;
		    canvas.height = img.height;
		    var context = canvas.getContext( '2d' );

		    var size = img.width * img.height;
			console.log(size);
		    var data = new Float32Array( size );

		    context.drawImage(img,0,0);

		    for ( var i = 0; i < size; i ++ ) {
		        data[i] = 0
		    }

		    var imgd = context.getImageData(0, 0, img.width, img.height);
		    var pix = imgd.data;

		    var j=0;
		    for (var i = 0; i<pix.length; i +=4) {
		        var all = pix[i]+pix[i+1]+pix[i+2];  // all is in range 0 - 255*3
		        data[j++] = scale*all/3;
		    }

		    return data;
		}

		function Start() {
			scene = new THREE.Scene();
			camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );

			renderer = new THREE.WebGLRenderer( {antialias: true} );
			renderer.setSize( window.innerWidth, window.innerHeight );
			renderer.setClearColor( 0x000000 );
			document.body.appendChild( renderer.domElement );

			camera.position.set(-5,20,45);
			camera.lookAt( new THREE.Vector3(0,0,0));

			stats = new Stats();
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			document.body.appendChild( stats.domElement );

			//mause controls
			controls = new THREE.OrbitControls( camera );
			controls.enableKeys = false;
			controls.addEventListener( 'change', Render );

			// le quattro frecce
			this.keys = { LEFT: 37, UP: 38, RIGHT: 39, BOTTOM: 40 };

			// gestisco l'evento di pressione di un tasto
			window.addEventListener( 'keydown', onKeyDown, false );

			// terrain
			var img = new Image();
			img.onload = function () {

				//get height data from img
				var data = getHeightData(img,0.1);
				// disegna tutti i cubi presenti in data usando i colori di img
				drawCubes(data, img);

			}
			// load img source
			img.src = "images/machu_picchu3.jpg";

			// set-up scena
			game = new SnakeGame(178.5,611,35.5);

		}

		/*
			gestisce la pressione di un qualsiasi tasto
		*/
		function onKeyDown( event ) {

			switch ( event.keyCode ) {
				case keys.RIGHT:
						//console.log("dx")
						game.direction = (game.direction != 2) ? 0 : 2;	// cambio direzione solo se non sto andando nella direzione opposta
					break;

				case keys.UP:
						//console.log("su")
						game.direction = (game.direction != 3) ? 1 : 3;	// cambio direzione solo se non sto andando nella direzione opposta
					break;

				case keys.LEFT:
						//console.log("sx")
						game.direction = (game.direction != 0) ? 2 : 0;	// cambio direzione solo se non sto andando nella direzione opposta
					break;

				case keys.BOTTOM:
						//console.log("giu")
						game.direction = (game.direction != 1) ? 3 : 1;	// cambio direzione solo se non sto andando nella direzione opposta
					break;
			}
		}

		function drawCubes(d, img){

			// viene usata una sola geometria per disegnare tutti i cubi
			var geometry = new THREE.BoxGeometry(1,1,1);
			// array di materiali utilizzati
			materials = [];

			var water_material = new THREE.MeshBasicMaterial();
      		water_material.map = new THREE.TextureLoader().load('textures/water.jpg')

			var textureLoader = new THREE.TextureLoader();

			/*************************************************
			*************************************************/

			var ground_bottom = textureLoader.load( './textures/minecraft2/bottom.jpg' );
			var ground_side = textureLoader.load( './textures/minecraft2/front.jpg' );
			var ground_top = textureLoader.load( './textures/minecraft2/top.jpg' );
			ground_side.wrapT = THREE.RepeatWrapping;
			ground_side.wrapS = THREE.RepeatWrapping;
			ground_side.repeat.set( 1, 6 );

			var ground_materials = [
			    new THREE.MeshBasicMaterial( { map: ground_side } ),
			    new THREE.MeshBasicMaterial( { map: ground_side } ),
			    new THREE.MeshBasicMaterial( { map: ground_top } ),
			    new THREE.MeshBasicMaterial( { map: ground_bottom } ),
			    new THREE.MeshBasicMaterial( { map: ground_side } ),
			    new THREE.MeshBasicMaterial( { map: ground_side } )
			];
			var ground_material = new THREE.MeshFaceMaterial( ground_materials );

			/*************************************************
			*************************************************/

			var rock_top = textureLoader.load( './textures/rock/top.png' );
			var rock_side = textureLoader.load( './textures/rock/side.png' );

			var rock_materials = [
			    new THREE.MeshBasicMaterial( { map: rock_side } ),
			    new THREE.MeshBasicMaterial( { map: rock_side } ),
			    new THREE.MeshBasicMaterial( { map: rock_top } ),
			    new THREE.MeshBasicMaterial( { map: rock_top } ),
			    new THREE.MeshBasicMaterial( { map: rock_side } ),
			    new THREE.MeshBasicMaterial( { map: rock_side } )
			];
			var rock_material = new THREE.MeshFaceMaterial( rock_materials );

			/*************************************************
			*************************************************/

			var hill_top = textureLoader.load( './textures/hill/top.jpg' );
			var hill_side = textureLoader.load( './textures/hill/side.jpg' );
			hill_side.wrapT = THREE.RepeatWrapping;
			hill_side.wrapS = THREE.RepeatWrapping;
			hill_side.repeat.set( 1, 6 );

			var hill_materials = [
			    new THREE.MeshBasicMaterial( { map: hill_side } ),
			    new THREE.MeshBasicMaterial( { map: hill_side } ),
			    new THREE.MeshBasicMaterial( { map: hill_top } ),
			    new THREE.MeshBasicMaterial( { map: hill_top } ),
			    new THREE.MeshBasicMaterial( { map: hill_side } ),
			    new THREE.MeshBasicMaterial( { map: hill_side } )
			];
			var hill_material = new THREE.MeshFaceMaterial( hill_materials );

			/*************************************************
			*************************************************/


			for(var i=0; i<d.length; i++){

				// colore del pixel(0 - 255) in considerazione
				var pColor = Math.trunc(d[i]*10);

				// controllo se il materiale da utilizzare esiste giÃ 
				var exist = -1;
				for(var j=0; j<materials.length; j++){
					if(Math.trunc(materials[j].color.r * 255) == pColor){
						exist = j;
						break;
					}
				}

				// se non esiste lo creo e lo aggiungo all'array di materiali
				if(exist == -1){
					exist = materials.length;
					materials[exist] = new THREE.MeshBasicMaterial( {color: "rgb(" + pColor + ", " + pColor + ", " + pColor + ")" } );	// materiale di colore uguale al pixel dell'immagine
				}

				var mat = materials[exist];

				
				// var mat = new THREE.MeshBasicMaterial( {color: 0xcfcfcf});

				if (d[i]<5){
					mat = water_material;
				} else if (d[i]<10){
					mat = ground_material;
				} else if (d[i]<15){
					// mat = hill_material;
				} else if (d[i]){
					// mat = rock_material;
				}

				var cube = new THREE.Mesh( geometry, mat );

				// imposto la posizione del cubo rispettando l'immagine originale
				cube.position.set(i%img.width - img.width/2, d[i]/2, Math.trunc(i/img.height) - img.height/2);
				// il cubo viene scalato in base al colore (0 basso - 25.5 alto)
				cube.scale.y = d[i];

				scene.add( cube );

			}

		}

		function Update() {
			requestAnimationFrame( Update );

			game.move();

			controls.update();
			stats.update();
			Render();
		}

		function Render() {
			renderer.render(scene, camera);
		}

		Start();
		Update();

		</script>
	</body>
</html>
