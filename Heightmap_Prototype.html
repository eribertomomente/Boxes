<html>
	<head>
		<title>Starting Code for 1st Project 2017</title>
		<style>

		body {
			font-family: Monospace;
			background-color: #f0f0f0;
			margin: 0px;
			overflow: hidden;
		}

		canvas {
			width: 100%;
			height: 100%;
		}

	</style>
		<script src="lib/three.min.js"></script>
		<script src="lib/stats.min.js"></script>
		<script src="lib/OrbitControls.js"></script>
	</head>
	<body>

		<script>

		var scene, camera, renderer, controls, stats;

		//return array with height data from img, taken from: http://danni-three.blogspot.it/2013/09/threejs-heightmaps.html
		function getHeightData(img,scale) {

			if (scale == undefined) scale=1;

	    var canvas = document.createElement( 'canvas' );
	    canvas.width = img.width;
	    canvas.height = img.height;
	    var context = canvas.getContext( '2d' );

	    var size = img.width * img.height;
			console.log(size);
	    var data = new Float32Array( size );

	    context.drawImage(img,0,0);

	    for ( var i = 0; i < size; i ++ ) {
	        data[i] = 0
	    }

	    var imgd = context.getImageData(0, 0, img.width, img.height);
	    var pix = imgd.data;

	    var j=0;
	    for (var i = 0; i<pix.length; i +=4) {
	        var all = pix[i]+pix[i+1]+pix[i+2];  // all is in range 0 - 255*3
	        data[j++] = scale*all/3;
	    }

	    return data;
		}

		function Start() {
			scene = new THREE.Scene();
			camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );


			renderer = new THREE.WebGLRenderer( {antialias: true} );
			renderer.setSize( window.innerWidth, window.innerHeight );
			renderer.setClearColor( 0xf0f0f0 );
			document.body.appendChild( renderer.domElement );


			camera.position.set(-5,20,45);
			camera.lookAt( new THREE.Vector3(0,0,0));


			stats = new Stats();
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			document.body.appendChild( stats.domElement );

			//mause controls
			controls = new THREE.OrbitControls( camera );
			controls.addEventListener( 'change', Render );

			// terrain
			var img = new Image();
			img.onload = function () {

				//get height data from img
				var data = getHeightData(img,0.1);
				// disegna tutti i cubi presenti in data usando i colori di img
				drawCubes(data, img);

			}
			// load img source
			img.src = "textures/heightmap2.png";

		}

		function drawCubes(d, img){

			// viene usata una sola geometria per disegnare tutti i cubi
			var geometry = new THREE.BoxGeometry(1,1,1);
			// array di materiali utilizzati
			materials = [];

			for(var i=0; i<d.length; i++){

				// colore del pixel(0 - 255) in considerazione
				var pColor = Math.trunc(d[i]*10);

				// controllo se il materiale da utilizzare esiste giÃ 
				var exist = -1;
				for(var j=0; j<materials.length; j++){
					if(Math.trunc(materials[j].color.r * 255) == pColor){
						exist = j;
						break;
					}
				}

				// se non esiste lo creo e lo aggiungo all'array di materiali
				if(exist == -1){
					exist = materials.length;
					materials[exist] = new THREE.MeshBasicMaterial( {color: "rgb(" + pColor + ", " + pColor + ", " + pColor + ")" } );	// materiale di colore uguale al pixel dell'immagine
				}

				var cube = new THREE.Mesh( geometry, materials[exist] );

				// imposto la posizione del cubo rispettando l'immagine originale
				cube.position.set(i%img.width - img.width/2, d[i]/2, Math.trunc(i/img.height) - img.height/2);
				// il cubo viene scalato in base al colore (0 basso - 25.5 alto)
				cube.scale.y = d[i];

				scene.add( cube );

			}

		}

		function Update() {
			requestAnimationFrame( Update );
			controls.update();
			stats.update();
			Render();
		}

		function Render() {
			renderer.render(scene, camera);
		}

		Start();
		Update();

		</script>
	</body>
</html>
